<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Wardrobe – Gallery</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="digitalWardrobe.css" />
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="./digitalWardrobe.html#home" class="brand">
        <img src="./images/logo.png" alt="MatchMuse logo" class="brand-mark">
        <span class="brand-name">MatchMuse</span>
      </a>

      <button class="nav-toggle" aria-expanded="false" aria-controls="nav">
        <span class="sr-only">Toggle navigation</span>☰
      </button>

      <nav id="nav" class="nav">
        <a href="./digitalWardrobe.html#explore">Explore</a>
        <a href="./digitalWardrobe.html#about">About</a>
        <a href="./digitalWardrobe.html#technology">Technology</a>
        <a href="./digitalWardrobe.html#faq">FAQ</a>
      </nav>
    </div>
  </header>

  <main class="section hero" id="gallery-hero" style="padding-top:96px;">
    <div class="container hero-grid">
      <div class="hero-copy">
        <h1>Your <span class="accent">Digital Wardrobe</span></h1>
        <p>Upload items into categories and generate cohesive outfit ideas.</p>
        <a class="btn btn-outline" href="./digitalWardrobe.html#home">← Back to Home</a>
      </div>
      <div class="hero-art">
        <img src="./images/hero-right.png" alt="Wardrobe hero art" />
      </div>
    </div>
  </main>

  <input type="file" id="fileInput" accept="image/*" style="display:none;" />

  <!-- Closet cards -->
  <section class="section" id="closet">
    <div class="container">
      <h2>Your Closet</h2>

      <div class="closet-grid">
        <!-- Tops -->
        <article class="closet-card">
          <header class="closet-card__header">
            <h3>Tops</h3>
            <button id="uploadButtonTops" class="btn btn-primary">Upload</button>
          </header>
          <div id="tops" class="gallery-grid" aria-live="polite"></div>
        </article>

        <!-- Bottoms -->
        <article class="closet-card">
          <header class="closet-card__header">
            <h3>Bottoms</h3>
            <button id="uploadButtonBottoms" class="btn btn-primary">Upload</button>
          </header>
          <div id="bottoms" class="gallery-grid" aria-live="polite"></div>
        </article>

        <!-- Shoes -->
        <article class="closet-card">
          <header class="closet-card__header">
            <h3>Shoes</h3>
            <button id="uploadButtonShoes" class="btn btn-primary">Upload</button>
          </header>
          <div id="shoes" class="gallery-grid" aria-live="polite"></div>
        </article>

        <!-- Accessories -->
        <article class="closet-card">
          <header class="closet-card__header">
            <h3>Accessories</h3>
            <button id="uploadButtonAccessories" class="btn btn-primary">Upload</button>
          </header>
          <div id="accessories" class="gallery-grid" aria-live="polite"></div>
        </article>

        <!-- Outerwear -->
        <article class="closet-card">
          <header class="closet-card__header">
            <h3>Outerwear</h3>
            <button id="uploadButtonOuterwear" class="btn btn-primary">Upload</button>
          </header>
          <div id="outerwear" class="gallery-grid" aria-live="polite"></div>
        </article>
      </div>
    </div>
  </section>

  <!-- Outfit generator -->
  <section class="section alt" id="generator">
    <div class="container narrow">
      <article class="generator-card">
        <div class="generator-card__header">
          <h2>Generate an Outfit</h2>
          <p>We’ll analyze one item from each category and render a cohesive look.</p>
        </div>
        <div class="generator-card__actions">
          <button id="makeOutfit" class="btn btn-primary">Generate Outfit</button>
        </div>
        <div class="generator-card__result">
            <figure class="outfit-preview">
                <div id="outfitpageSpinner" class="spinner" hidden aria-live="polite" aria-busy="true" aria-label="Generating outfit"></div>
                <img id="outfit" alt="Generated outfit" hidden />
                <figcaption id="outfitpageStatus" aria-live="polite" class="prose" style="text-align:center;color:var(--ink-2)"></figcaption>
                <div id="outfitMeta" class="prose"></div>
            </figure>
        </div>
      </article>
    </div>

    <script>
        (function () {
          const btn = document.getElementById('makeOutfit');
          const img = document.getElementById('outfit');
          const statusEl = document.getElementById('outfitpageStatus');
          const spinner = document.getElementById('outfitpageSpinner');   
      
          if (!(btn && img && statusEl && spinner)) return;
      
          btn.addEventListener('click', async () => {
            btn.disabled = true;
            statusEl.textContent = 'Generating outfit...';
      
            // Hide placeholder + reset src so the next load event will fire
            spinner.hidden = false;
            img.hidden = true;
            img.removeAttribute('src');
      
            const base = location.origin.startsWith('file:') ? 'http://localhost:3000' : '';
      
            try {
              const res = await fetch(base + '/api/outfit/generate');
              if (!res.ok) throw new Error('HTTP ' + res.status);
              const data = await res.json();
              if (!data.imageUrl) throw new Error(data.error || 'No imageUrl returned');
      
              // Show only after the image is fully loaded
              img.addEventListener(
                'load',
                () => {
                  spinner.hidden = true;
                  img.hidden = false;
                  statusEl.textContent = 'Outfit generated ✔';
                },
                { once: true }
              );
      
              img.addEventListener(
                'error',
                () => {
                  statusEl.textContent = 'Image failed to load. Trying to load again.';
                },
                { once: true }
              );
      
              img.src = data.imageUrl.startsWith('http') ? data.imageUrl : base + data.imageUrl;
            } catch (e) {
              console.error(e);
              spinner.hidden = true;
              statusEl.textContent = 'Something went wrong. Please try again.';
            } finally {
              btn.disabled = false;
            }
          });
        })();
    </script>
  </section>

  <!-- History: previously generated outfits -->
<section class="section" id="history">
    <div class="container">
      <h2>Previously Generated Outfits</h2>
      <div id="historyGrid" class="gallery-grid" aria-live="polite"></div>
      <p id="historyEmpty" class="prose" style="color:var(--ink-2); display:none;">
        No outfits yet — generate your first one above!
      </p>
    </div>
  </section>
  <script>
    (function(){
      const historyGrid = document.getElementById('historyGrid');
      const historyEmpty = document.getElementById('historyEmpty');
      const base = location.origin.startsWith('file:') ? 'http://localhost:3000' : '';
  
      async function loadHistory() {
        try {
          const res = await fetch(base + '/api/generated');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const items = await res.json();
          historyGrid.innerHTML = '';
  
          if (!items.length) {
            historyEmpty.style.display = 'block';
            return;
          }
          historyEmpty.style.display = 'none';
  
          items.forEach(it => {
            const img = document.createElement('img');
            img.src = it.url.startsWith('http') ? it.url : (base + it.url);
            img.alt = 'Previously generated outfit';
            historyGrid.appendChild(img);
          });
        } catch (e) {
          console.error('Failed to load history:', e);
        }
      }
  
      // Load on page open
      document.addEventListener('DOMContentLoaded', loadHistory);
  
      // Also append the newly generated image when the user clicks Generate
      const btn = document.getElementById('makeOutfit');
      const statusEl = document.getElementById('outfitpageStatus');
      const img = document.getElementById('outfit');
  
      if (btn && img && statusEl) {
        btn.addEventListener('click', async () => {
          // We reuse your existing generate code; after success we prepend the new image:
          const mutationObserver = new MutationObserver(() => {
            if (img.src) {
              // Prepend newest
              const thumb = document.createElement('img');
              thumb.src = img.src;
              thumb.alt = 'Previously generated outfit';
              historyEmpty.style.display = 'none';
              historyGrid.prepend(thumb);
              mutationObserver.disconnect();
            }
          });
          mutationObserver.observe(img, { attributes: true, attributeFilter: ['src'] });
        });
      }
    })();
  </script>
<script src="../src/gallery.js" defer></script>
</body>
</html>